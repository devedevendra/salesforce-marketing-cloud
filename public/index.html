<!DOCTYPE html>
<html>
<head>
    <title>PCM Custom Activity</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/postmonger@0.0.16/postmonger.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <!-- APP_URL --> <!-- DO NOT DELETE THIS LINE -->
    <style>
        /* Existing styles */
    #designPreviewModal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    .modal-content {
        background-color: #fefefe;
        /* margin: 15% auto;  15% from the top and centered - REMOVED */
        padding: 20px;
        border: 1px solid #888;
        /* width: 80%;  Could be more or less, depending on screen size - REMOVED */

        /* Fullscreen modifications */
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        margin: 0;   /* No margin */
        border: none; /* No border */
        border-radius: 0; /* No rounded corners */
    }

    .close-button {
        color: rgb(31 115 211);
        float: right;
        /*font-size: 28px;*/
        font-weight: bold;
        align-self: self-end;

    }

    .close-button:hover,
    .close-button:focus {
        color:rgb(15 68 134);
        text-decoration: none;
        cursor: pointer;
    }

    #pdfViewerModal {
        width: 100%;
        height: calc(100% - 60px); /* Adjust as needed, subtract header height */
        border: none;
    }

    #pdfViewerContainerModal {
        height: calc(100% - 60px); /* Match iframe height */
    }

    #imageCarouselModal.owl-carousel {
        height: calc(100% - 60px); /* Adjust carousel height */
    }

    .carousel-container-modal {
        width: 100%;
        height: 100%;
    }

    .carousel-container-modal img {
        max-width: 100%;
        max-height: 100%; /* Ensure images fit within the carousel */
        object-fit: contain; /* Preserve aspect ratio and fit */
    }
    .invalid-feedback { /* Ensure invalid feedback is visible */
        display: none; /* Initially hidden by Bootstrap, shown by JS or Bootstrap's validation */
        width: 100%;
        margin-top: .25rem;
        font-size: .875em;
        color: #dc3545;
    }
    select.is-invalid, input.is-invalid {
        border-color: #dc3545;
    }
    </style>
</head>
<body>
    <div class="container mt-2" id="topPanel">
        <div class="row" >
            <div class="col-md-6  border-end" >
                <img class="logo logo-image" src="/images/logo-postcardmania-black-text.svg" alt="PostcardMania Logo" style="height:50px;">  </div>
            </div>
        </div>
    </div>
    
    <div id="error" class="alert alert-danger" style="display: none;"></div>
    <div class="container mt-4" id="configPanel">
        
        <p>Map fields from the entry source Data Extension to process.</p>
        <form id="configForm" class="row" novalidate>
            <div class="col-md-6 order-md-1 border-end" style="border-right:3px solid #f5f5f5">
                    <h5 class="mb-3">Recipient address</h5>
                    <div class="row">
                        <div class="form-group col-md-6 mb-3">
                            <label for="firstNameField">First Name:</label>
                            <select class="form-control" id="firstNameField" name="firstNameField" required>
                                <option value="">-- Select Mapping --</option>
                            </select>
                            <div class="invalid-feedback">First Name mapping is required.</div>
                        </div>
                    
                        <div class="form-group col-md-6 mb-3">
                            <label for="lastNameField">Last Name:</label>
                            <select class="form-control" id="lastNameField" name="lastNameField" required>
                                <option value="">-- Select Mapping --</option>
                            </select>
                            <div class="invalid-feedback">Last Name mapping is required.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-12 mb-3">
                            <label for="companyField">Company:</label>
                            <select class="form-control" id="companyField" name="companyField"  placeholder="Company" required>
                                <option value="">-- Select Mapping --</option>
                            </select>
                            <div class="invalid-feedback">Company mapping is required.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6 mb-3">
                            <label for="streetField">Address:</label>
                            <select class="form-control" id="streetField" name="streetField" required>
                                <option value="">-- Select Mapping --</option>
                            </select>
                            <div class="invalid-feedback">Address mapping is required.</div>
                        </div>
                    
                        <div class="form-group col-md-6 mb-3">
                            <label for="cityField">City:</label>
                            <select class="form-control" id="cityField" name="cityField" required>
                                <option value="">-- Select Mapping --</option>
                            </select>
                            <div class="invalid-feedback">City mapping is required.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6 mb-3">
                            <label for="stateField">State:</label>
                            <select class="form-control" id="stateField" name="stateField" required>
                                <option value="">-- Select a Field --</option>
                            </select>
                            <div class="invalid-feedback">State mapping is required.</div>
                        </div>
                    
                        <div class="form-group col-md-6 mb-3">
                            <label for="postalCodeField">Postal/Zip Code:</label>
                            <select class="form-control" id="postalCodeField" name="postalCodeField" required>
                                <option value="">-- Select a Field --</option>
                            </select>
                            <div class="invalid-feedback">Postal/Zip Code mapping is required.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-12 mb-3">
                            <label for="designIdSelect">Select Design:</label>
                            <select class="form-control" id="designIdSelect" name="designId" required>
                                <option value="">-- Select a Design --</option>
                            </select>
                            <div class="invalid-feedback">Design selection is required.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-12 mb-3" id="previewPanel" style="display: none;">
                            <a href="javascript:void(0);" onclick="showPreview();" >View Design Proof</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-12 mb-3" id="mailClassPanel" style="display: none;">
                            <label for="mailClassSelect">Select MailClass:</label>
                            <select class="form-control" id="mailClassSelect" name="mailClassId" required>
                            </select>
                            <div class="invalid-feedback">MailClass selection is required.</div>
                        </div>
                    </div>
                    <div id="letterOptionsContainer" class="row mt-3" style="display: none;">
                    <div class="col-md-12">
                        <h5>Letter Options</h5>
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="letterColorField">Color:</label>
                                <select id="letterColorField" name="letterColorField" class="form-control" required>
                                    <option value="false">Black & White</option>
                                    <option value="true">Color</option>
                                </select>
                                <div class="invalid-feedback">Letter Color selection is required.</div>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="letterPrintBothSidesField">Print on Both Sides:</label>
                                <select id="letterPrintBothSidesField" name="letterPrintBothSidesField" class="form-control" required>
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                                <div class="invalid-feedback">Print on Both Sides selection is required.</div>
                            </div>
                            <div class="form-group col-md-12">
                                <label for="letterInsertAddressPageField">Insert Addressing Page:</label>
                                <select id="letterInsertAddressPageField" name="letterInsertAddressPageField" class="form-control" required>
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                                <div class="invalid-feedback">Insert Addressing Page selection is required.</div>
                            </div>
                        </div>
                    </div>
                </div>

                    <div id="envelopeOptionsContainer" class="row mt-3" style="display: none;">
                        <div class="col-md-12">
                            <h5>Envelope Options</h5>
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label for="envelopeTypeField">Type:</label>
                                    <select id="envelopeTypeField" name="envelopeTypeField" class="form-control" required>
                                    </select>
                                    <div class="invalid-feedback">Envelope Type is required.</div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="envelopeFontField">Font:</label>
                                    <select id="envelopeFontField" name="envelopeFontField" class="form-control" required>
                                    </select>
                                    <div class="invalid-feedback">Envelope Font is required.</div>
                                </div>
                                <div class="form-group col-md-12">
                                    <label for="envelopeFontColorField">Font Color:</label>
                                    <select id="envelopeFontColorField" name="envelopeFontColorField" class="form-control" required>
                                    </select>
                                    <div class="invalid-feedback">Envelope Font Color is required.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="snapApartOptionsContainer" class="row mt-3" style="display: none;">
                        <div class="col-md-12">
                            <h5>Snap Apart Options</h5>
                            <div class="row">
                                <div class="form-group col-md-12">
                                    <label for="snapApartColorField">Color:</label>
                                    <select id="snapApartColorField" name="snapApartColorField" class="form-control" required>
                                        <option value="false">Black & White</option>
                                        <option value="true">Color</option>
                                    </select>
                                    <div class="invalid-feedback">Snap Apart Color selection is required.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="snapApartAddressingOptionsContainer" class="row mt-3" style="display: none;">
                        <div class="col-md-12">
                            <h5>Addressing Options</h5>
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label for="snapApartFontField">Font:</label>
                                    <select id="snapApartFontField" name="snapApartFontField" class="form-control" required>
                                    </select>
                                    <div class="invalid-feedback">Snap Apart Font is required.</div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="snapApartFontColorField">Font Color:</label>
                                    <select id="snapApartFontColorField" name="snapApartFontColorField" class="form-control" required>
                                    </select>
                                    <div class="invalid-feedback">Snap Apart Font Color is required.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="dynamicDesignFieldsContainer">
                        
                    </div>
                    
                    </div>
        
            <div class="col-md-6 order-md-2 mb-4">
                <h5 class="mb-3">Return address</h5>
                
                <div class="row">
                    <div class="form-group col-md-6 mb-3">
                        <label for="rfirstNameField">First Name:</label>
                        <input type="text" class="form-control" id="rfirstNameField" name="rfirstNameField" placeholder="First Name" required>
                        <div class="invalid-feedback">First Name is required.</div>
                    </div>
                
                    <div class="form-group col-md-6 mb-3">
                        <label for="rlastNameField">Last Name:</label>
                        <input type="text" class="form-control" id="rlastNameField" name="rlastNameField" placeholder="Last Name" required>
                        <div class="invalid-feedback">Last Name is required.</div>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group col-md-12 mb-3">
                        <label for="rcompanyField">Company:</label>
                        <input type="text" class="form-control" id="rcompanyField" name="rcompanyField" placeholder="Company Name" required>
                        <div class="invalid-feedback">Company mapping is required.</div>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group col-md-6 mb-3">
                        <label for="rstreetField">Address:</label>
                        <input type="text" class="form-control" id="rstreetField" name="rstreetField" placeholder="Street Name" required>
                        <div class="invalid-feedback">Address is required.</div>
                    </div>
                
                    <div class="form-group col-md-6 mb-3">
                        <label for="rcityField">City:</label>
                        <input type="text" class="form-control" id="rcityField" name="rcityField" placeholder="City" required>
                        <div class="invalid-feedback">City is required.</div>
                    </div>
                
                    <div class="form-group col-md-6 mb-3">
                        <label for="rstateField">State:</label>
                        <input type="text" class="form-control" id="rstateField" name="rstateField" placeholder="State" required>
                        <div class="invalid-feedback">State is required.</div>
                    </div>

                    <div class="form-group col-md-6 mb-3">
                        <label for="rpostalCodeField">Postal Code:</label>
                        <input type="text" class="form-control" id="rpostalCodeField" name="rpostalCodeField" placeholder="Postal/Zip Code" required>
                        <div class="invalid-feedback">Postal Code is required.</div>
                    </div>
                </div>

            </div>
        
        </form>

    </div>
    <div class="container mt-4" id="regPanel">
        
        <form id="regForm">
            <div class="form-group">
                <label for="apiKey">API Key:</label>
                <input type="text" class="form-control" id="apiKey" name="apiKey" placeholder="Enter API Key" required>
                 <div class="invalid-feedback">API Key is required.</div> </div>
            <div class="form-group">
                <label for="apiSecret">API Secret:</label>
                <input type="text" class="form-control" id="apiSecret" name="apiSecret" placeholder="Enter API Secret" required>
                <div class="invalid-feedback">API Secret is required.</div> </div>
            <div class="form-group">
                <label for="jwtSecret">JWT Secret:</label>
                <input type="text" class="form-control" id="jwtSecret" name="jwtSecret" placeholder="Enter JWT Secret from PCM under Setup>Apps>Installed Packages" required>
                <div class="invalid-feedback">JWT Secret is required.</div> </div>
            
            <button type="button" class="btn btn-primary"  onclick="handleRegistration()">Register</button>
        </form>
        <div id="registrationStatus" style="margin-top: 15px;"></div>
    </div>
    <div id="designPreviewModal" class="modal">
        <div class="modal-content">
            <span class="close-button">Click here to Close Preview</span>
            <h5>Design Preview:</h5>
            <div id="pdfViewerContainerModal" style="display: none;">
                <iframe id="pdfViewerModal" src="" frameborder="0"></iframe>
            </div>
            <div id="imageCarouselModal" class="owl-carousel owl-theme" style="display: none;">
            </div>
        </div>
    </div>
    <script>

        // Add these constants at the beginning of your script or in an accessible scope
        const ENVELOPE_TYPES = [
            { key: "doubleWindow", label: "Double Window" },
            { key: "fullWindow", label: "Full Window" },
            { key: "Regular", label: "Regular" },
            { key: "BiFold", label: "Bi-Fold Regular" },
        ];

        const ENVELOPE_FONTS = [
                {
                    key: "Standard",
                    label: "Standard",
                    font: "font-serif",
                },
                {
                    key: "Bradley Hand",
                    label: "Bradley Hand",
                    font: "Bradley Hand",
                },
                {
                    key: "Blackjack",
                    label: "Blackjack",
                    font: "Blackjack",
                },
                {
                    key: "FG Cathies Hand",
                    label: "FG Cathies Hand",
                    font: "FG Cathies Hand",
                },
                {
                    key: "Crappy Dan",
                    label: "Crappy Dan",
                    font: "Crappy Dan",
                },
                {
                    key: "Dakota",
                    label: "Dakota",
                    font: "Dakota",
                },
                {
                    key: "Jenna Sue",
                    label: "Jenna Sue",
                    font: "Jenna Sue",
                },
                {
                    key: "Reenie Beanie",
                    label: "Reenie Beanie",
                    font: "Reenie Beanie",
                },
                ]

        const FONT_COLORS = [
            { key: "Black", label: "Black" },
            { key: "Blue", label: "Blue" },
            { key: "Green", label: "Green" },
        ];

        let sfmcMID;
        let sfmcRestHost;
        let initialDataLoaded = false;
        async function handleRegistration() {
            const registrationStatusDiv = document.getElementById('registrationStatus');
            // Clear previous status messages and styling
            registrationStatusDiv.textContent = '';
            registrationStatusDiv.className = ''; // Clears any 'text-danger' or 'text-success' etc.
            $('#regForm .is-invalid').removeClass('is-invalid'); // Clear previous Bootstrap errors
        
            // 1. Get values from the form inputs
            const apiKeyInput = document.getElementById('apiKey');
            const apiSecretInput = document.getElementById('apiSecret');
            const jwtSecretInput = document.getElementById('jwtSecret'); // For the form's JWT Secret field
        
            const apiKey = apiKeyInput.value.trim();
            const apiSecret = apiSecretInput.value.trim();
            const jwtSecretFromForm = jwtSecretInput.value.trim(); // Value from the form's JWT Secret input
        
            // 2. Validation for each field
            let validationErrors = [];
            if (!apiKey) {
                validationErrors.push("API Key is required.");
                apiKeyInput.classList.add('is-invalid');
            } else {
                 apiKeyInput.classList.remove('is-invalid');
            }
        
            if (!apiSecret) {
                validationErrors.push("API Secret is required.");
                apiSecretInput.classList.add('is-invalid');
            } else {
                apiSecretInput.classList.remove('is-invalid');
            }
        
            if (!jwtSecretFromForm) { // Validating the JWT Secret from the form input
                validationErrors.push("JWT Secret is required.");
                 jwtSecretInput.classList.add('is-invalid');
            } else {
                jwtSecretInput.classList.remove('is-invalid');
            }
        
            if (validationErrors.length > 0) {
                registrationStatusDiv.innerHTML = validationErrors.join('<br>'); // Display all errors
                registrationStatusDiv.className = 'text-danger'; // Bootstrap class for error styling
                return; // Stop execution if there are validation errors
            }
        
            registrationStatusDiv.textContent = 'Registering... Please wait.';
            registrationStatusDiv.className = 'text-info'; // Bootstrap class for info styling
        
            try {
                // Define the URL for your backend registration endpoint
                // If your frontend and backend are on different origins, use the full URL.
                // If APP_URL is defined globally and points to your backend:
                // const backendRegistrationUrl = `${window.APP_URL || ''}/api/registration`;
                //const backendRegistrationUrl = '/api/registration'; // Assuming same origin
        
                // 3. Call your backend API
                const response = await fetch(`${window.APP_URL}/api/registration`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiSecret: apiSecret,
                        jwtSecret: jwtSecretFromForm,
                        mid : sfmcMID // Sending the form's JWT secret to the backend
                    })
                });
        
                // 4. Handle the response from your backend
                let responseData;
                try {
                    responseData = await response.json(); // Attempt to parse the response as JSON
                } catch (jsonError) {
                    // This catches errors if response.json() fails (e.g., backend sent non-JSON error page)
                    console.error('Failed to parse JSON response from backend:', jsonError);
                    if (!response.ok) { // HTTP error status and non-JSON body
                        throw new Error(`Registration failed: Server responded with status ${response.status} and an unreadable error format.`);
                    } else { // HTTP OK status but non-JSON body (unexpected)
                        throw new Error('Received an unexpected non-JSON response from the server.');
                    }
                }
        
                if (!response.ok) {
                    // The backend should send a JSON error like { success: false, error: "message", errorCode: "..." }
                    console.error('Backend registration failed:', responseData);
                    const errorMessage = responseData.error || responseData.message || `Registration failed with status: ${response.status}`;
                    throw new Error(errorMessage);
                }
        
                // Assuming your backend sends { success: true, message: "...", ... }
                if (responseData.success) {
                    console.log('Registration successful:', responseData);
                    registrationStatusDiv.textContent = responseData.message || 'Registration process completed successfully!';
                    registrationStatusDiv.className = 'text-success'; // Bootstrap class for success
                    // Optionally, clear the form or redirect
                    // apiKeyInput.value = '';
                    // apiSecretInput.value = '';
                    // jwtSecretInput.value = '';
                    console.log('Designs data received from backend:', JSON.stringify(responseData));
                    designsData = responseData.designsData.results || []; // Store the designs data
                    const $designSelect = $('#designIdSelect');
                    designsData.forEach(design => {
                        $designSelect.append(`<option value="${design.designID}">${design.designID} - ${design.productType} - ${design.friendlyName}</option>`);
                    });

                    $('#error').hide();
                    setTimeout(function(){
                        $('#configPanel').show();
                        $('#regPanel').hide(); 
                    },3000);
                } else {
                    // This case handles if response.ok was true (e.g., status 200) but your backend's
                    // business logic indicated a failure (e.g., by sending { success: false, error: "..." })
                    console.error('Backend indicated registration failure:', responseData);
                    const errorMessage = responseData.error || responseData.message || 'Registration failed. Please review details.';
                    throw new Error(errorMessage);
                }
        
            } catch (error) {
                // This catches:
                // - Network errors from the fetch call itself
                // - Errors thrown from !response.ok block
                // - Errors thrown if responseData.success is false
                // - JSON parsing errors that led to an error being thrown
                console.error('Full registration process failed:', error);
                registrationStatusDiv.textContent = `Error: ${error.message}`;
                registrationStatusDiv.className = 'text-danger';
            }
        }

        //
        function showPreview(){
            
            const selectedDesignId = $('#designIdSelect').val();
                    
            showDesignPreviewModal(parseInt(selectedDesignId));
        }

        if (typeof Postmonger === 'undefined') {
            console.error('Postmonger failed to load');
            $('#error').text('Error: Could not load Postmonger. Please check your network connection.').show();
        } else if (!window.APP_URL) {
            console.error('APP_URL not defined');
            $('#error').text('Error: Application URL not defined. Please set the APP_URL environment variable.').show();
        } else {
            const connection = new Postmonger.Session();
            let dataExtensionSchemaFields = []; 
            let payload = {};
            let schema = [];
            let tokens ={};
            let endpoints = {};
            let dataExtensionKey = '';
            let fieldMappings = {
                firstName: '',
                lastName: '',
                company: '',
                street: '',
                city: '',
                state: '',
                postalCode: '',
                // country: '', // Add if countryField is re-enabled in HTML
                designId: '',
                rfirstName: '',
                rlastName: '',
                rcompany: '',
                rstreet: '',
                rcity: '',
                rstate: '',
                rpostalCode: '',
                dynamicFields: {},
                mailClass:'',
                // Letter/Envelope options
                letterColor: 'false',
                letterPrintBothSides: 'false',
                letterInsertAddressPage: 'false',
                envelopeType: '',
                envelopeFont: '',
                envelopeFontColor: '',

                // New Snap Apart options
                snapApartColor: 'false', // Default to 'false' (Black & White)
                snapApartFont: '',
                snapApartFontColor: ''
            };
            let designsData = []; // To store the received designs data
            const modal = document.getElementById("designPreviewModal");
            const closeButton = document.querySelector(".close-button");

            $(window).ready(function() {
                console.log('Window ready, triggering ready event');
                connection.trigger('ready');
                connection.trigger('requestTokens');
                connection.trigger('requestEndpoints');
                connection.trigger('requestSchema');
                
                $('#configPanel').hide();
                $('#regPanel').hide();
                // Close modal when clicking outside
                window.addEventListener('click', function(event) {
                    if (event.target == modal) {
                        modal.style.display = "none";
                        // Optionally stop carousel autoplay if it was active
                        const $imageCarouselModal = $('#imageCarouselModal');
                        if ($imageCarouselModal.hasClass('owl-loaded')) {
                            $imageCarouselModal.trigger('stop.owl.autoplay');
                        }
                    }
                });

                // Close modal when clicking the close button
                closeButton.addEventListener('click', function() {
                    modal.style.display = "none";
                    // Optionally stop carousel autoplay if it was active
                    const $imageCarouselModal = $('#imageCarouselModal');
                    if ($imageCarouselModal.hasClass('owl-loaded')) {
                        $imageCarouselModal.trigger('stop.owl.autoplay');
                    }
                });
                
            });

            connection.on('initActivity', function(data) {
                console.log('initActivity called with data:', JSON.stringify(data));
                payload = data || {};
                if (payload.errors) {
                    console.log('Clearing pre-existing errors:', JSON.stringify(payload.errors));
                    payload.errors = null;
                }
                if (payload['arguments'] && payload['arguments'].execute && payload['arguments'].execute.inArguments) {
                    const inArgs = payload['arguments'].execute.inArguments[0] || {};

                    console.log('inArgs', inArgs);
                    dataExtensionKey = inArgs.dataExtension || dataExtensionKey;
                    fieldMappings.firstName = inArgs.first_name_field || ''; 
                    fieldMappings.lastName = inArgs.last_name_field || '';
                    fieldMappings.company = inArgs.company_field || '';
                    fieldMappings.street = inArgs.street_field || '';
                    fieldMappings.city = inArgs.city_field || '';
                    fieldMappings.state = inArgs.state_field || '';
                    fieldMappings.postalCode = inArgs.postal_code_field || '';
                    // fieldMappings.country = inArgs.country_field || ''; // If used

                    fieldMappings.designId = inArgs.selectedDesignId || '';
                    fieldMappings.mailClass = inArgs.mailClass || ''; // Load mailClass from inArguments
                    // Load return address values
                    fieldMappings.rfirstName = inArgs.rfirst_name || '';
                    fieldMappings.rlastName = inArgs.rlast_name || '';
                    fieldMappings.rcompany = inArgs.rcompany || '';
                    fieldMappings.rstreet = inArgs.rstreet || '';
                    fieldMappings.rcity = inArgs.rcity || '';
                    fieldMappings.rstate = inArgs.rstate || '';
                    fieldMappings.rpostalCode = inArgs.rpostal_code || ''; 

                    // Load Letter/Envelope options
                    if (inArgs.letter_options) {
                        try {
                            const letterOpts = JSON.parse(inArgs.letter_options);
                            fieldMappings.letterColor = letterOpts.letterColor !== undefined ? String(letterOpts.letterColor) : 'false';
                            fieldMappings.letterPrintBothSides = letterOpts.letterPrintBothSides !== undefined ? String(letterOpts.letterPrintBothSides) : 'false';
                            fieldMappings.letterInsertAddressPage = letterOpts.letterInsertAddressPage !== undefined ? String(letterOpts.letterInsertAddressPage) : 'false';
                            fieldMappings.envelopeType = letterOpts.envelopeType || '';
                            fieldMappings.envelopeFont = letterOpts.envelopeFont || '';
                            fieldMappings.envelopeFontColor = letterOpts.envelopeFontColor || '';
                        } catch (e) { console.error("Error parsing letter_options", e); }
                    }


                    // Load Snap Apart options
                     if (inArgs.snapapart_options) {
                        try {
                            const snapOpts = JSON.parse(inArgs.snapapart_options);
                            fieldMappings.snapApartColor = snapOpts.snapApartColor !== undefined ? String(snapOpts.snapApartColor) : 'false';
                            fieldMappings.snapApartFont = snapOpts.snapApartFont || '';
                            fieldMappings.snapApartFontColor = snapOpts.snapApartFontColor || '';
                        } catch (e) { console.error("Error parsing snapapart_options", e); }
                    }
                    
                    // Load dynamic field mappings
                    fieldMappings.dynamicFields = {}; // Initialize
                    if (inArgs.dynamic_fields) {
                        try {
                            const dynamicFieldsFromPayload = JSON.parse(inArgs.dynamic_fields);
                            for (const key in dynamicFieldsFromPayload) {
                                if (dynamicFieldsFromPayload.hasOwnProperty(key) && key.startsWith('df_') && key.endsWith('_mappedTo')) {
                                    const designFieldKey = key.substring(3, key.length - '_mappedTo'.length);
                                    fieldMappings.dynamicFields[designFieldKey] = dynamicFieldsFromPayload[key];
                                }
                            }
                        } catch (e) { console.error("Error parsing dynamic_fields", e); }
                    }


                    console.log('Loaded saved field mappings:', fieldMappings);
                    //console.log('Loaded saved DE key:', dataExtensionKey);
                    //$('#dataExtensionKey').val(dataExtensionKey); // This input is commented out in HTML
                    updateFieldSelections(); 
                }
            });

            connection.on('requestedTokens', function(data) {
                console.log('requestedTokens received:', JSON.stringify(data));
                tokens = data;
                if (tokens && tokens.MID ) { // Ensure MID exists
                    sfmcMID = tokens.MID; 
                    if (sfmcRestHost) { // Check if endpoints are already available
                        runWhenReady(); 
                    }
                } else {
                    console.error('Invalid or missing MID in requestedTokens data:', tokens);
                    $('#error').text('Error: Failed to receive valid authentication token (MID).').show();
                }
            });

            connection.on('requestedEndpoints', function(data) {
                console.log('requestedEndpoints received:', JSON.stringify(data));
                endpoints = data;
                if (endpoints && endpoints.fuelapiRestHost) {
                    sfmcRestHost = endpoints.fuelapiRestHost; 
                     if (sfmcMID) { 
                        runWhenReady(); 
                    }
                } else {
                    console.error('Invalid or missing fuelapiRestHost in requestedEndpoints data:', endpoints);
                    $('#error').text('Error: Failed to receive valid API endpoint information.').show();
                }
            });


            function runWhenReady() {
                if (initialDataLoaded) {
                    return;
                }
                initialDataLoaded = true; 

                console.log("Tokens (MID) and Endpoints are both available!");
                console.log("Using MID:", !!sfmcMID); 
                
                try{
                    verifyAuth();
                }catch(e){
                    console.log(e);
                }
            }


            async function verifyAuth() {
                if (!sfmcMID) {
                    console.error('Cannot verify authentication: MID missing.');
                    $('#error').text('Verification failed: MID is missing.').show();
                    $('#deLoadStatus').hide(); 
                    return;
                }
            
                $('#error').hide();
                $('#deLoadStatus').text('Verifying authentication...').show(); // Assuming #deLoadStatus exists
                console.log('Calling /api/verify...'); 
            
                try {
                    const response = await fetch(`${window.APP_URL}/api/verify`, { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            mid: sfmcMID
                        })
                    });
            
                    if (!response.ok) {
                        let errorDetails = `HTTP error! Status: ${response.status}`;
                        try {
                            const errorBody = await response.json(); 
                            errorDetails += ` - Message: ${JSON.stringify(errorBody.message || errorBody)}`;
                        } catch (e) {
                            console.warn('Could not parse error response body:', e);
                        }
                        throw new Error(errorDetails); 
                    }
            
                    const result = await response.json();
            
                    if (result.success && result.existingUser) {
                        //console.log("Verification successful. User exists. Token:", result.token);
                        $('#deLoadStatus').text('User verified. Loading designs...').show();
                        await fetchDesigns(result.token);
                        $('#configPanel').show();
                        // $('#deLoadStatus').hide(); // Or update as needed
                    } else if (result.success && !result.existingUser) {
                        console.log("Verification successful. User not found/new user.");
                        $('#deLoadStatus').text('User not found. Please complete registration.').show();
                        $('#regPanel').show();
                    } else {
                        const errorMessage = result.message || 'Unknown verification error';
                        const errorCode = result.errorCode ? ` (Code: ${result.errorCode})` : '';
                        console.error("Verification failed on backend:", errorMessage, errorCode);
                        $('#error').text(`Verification failed: ${errorMessage}${errorCode}`).show();
                        $('#deLoadStatus').text('Verification attempt failed.').show();
                    }
                } catch (error) {
                    console.error('Error during verification process:', error);
                    $('#deLoadStatus').text('An error occurred during verification.').show();
                    $('#error').text(`Error: ${error.message || 'The verification process failed. Please try again later.'}`).show();
                }
            }


            connection.on('requestedSchema', function(data) {
                console.log('requestedSchema received:', JSON.stringify(data));
                schema = data.schema || [];
                if (schema.length > 0) {
                    const firstKey = schema[0].key;
                    // Example: "Event.APIEvent-01234567-abcd-1234-efgh-c1c1c1c1c1c1.ContactKey"
                    // We want "APIEvent-01234567-abcd-1234-efgh-c1c1c1c1c1c1"
                    const keyParts = firstKey.split('.');
                    if (keyParts.length > 1) {
                        dataExtensionKey = keyParts[1]; // This should be the DE Key
                    } else {
                         dataExtensionKey = firstKey; // Fallback, though less likely for DE schema
                    }

                    console.log('Extracted Data Extension key from schema:', dataExtensionKey);
                    //$('#dataExtensionKey').val(dataExtensionKey); // This input is commented
                    populateFieldDropdowns();
                } else {
                    console.error('No schema data received or schema is empty');
                    $('#error').text('Error: No schema data received from Journey Builder.').show();
                }
            });

            /**
            * Validates that either (First Name AND Last Name) OR Company field is provided.
            * Shows/hides Bootstrap invalid feedback messages accordingly.
            *
            * @param {string} firstNameFieldId - The ID of the first name select/input field.
            * @param {string} lastNameFieldId - The ID of the last name select/input field.
            * @param {string} companyFieldId - The ID of the company select/input field.
            * @param {Array<string>} errorMessagesArray - An array to push specific error messages into.
            * @returns {boolean} True if validation passes, false otherwise.
            */
            function validateNameOrCompany(firstNameFieldId, lastNameFieldId, companyFieldId, errorMessagesArray) {
                const $firstNameField = $(`#${firstNameFieldId}`);
                const $lastNameField = $(`#${lastNameFieldId}`);
                const $companyField = $(`#${companyFieldId}`);

                const firstNameValue = $firstNameField.val();
                const lastNameValue = $lastNameField.val();
                const companyValue = $companyField.val();

                const firstNameProvided = firstNameValue && String(firstNameValue).trim() !== '';
                const lastNameProvided = lastNameValue && String(lastNameValue).trim() !== '';
                const companyProvided = companyValue && String(companyValue).trim() !== '';

                let isValid = false;

                // Clear previous states
                $firstNameField.removeClass('is-invalid').closest('.form-group').find('.invalid-feedback').hide().text('');
                $lastNameField.removeClass('is-invalid').closest('.form-group').find('.invalid-feedback').hide().text('');
                $companyField.removeClass('is-invalid').closest('.form-group').find('.invalid-feedback').hide().text('');

                if (firstNameProvided && lastNameProvided) {
                    isValid = true; // Both first and last name are provided
                } else if (companyProvided) {
                    isValid = true; // Company is provided
                }

                if (!isValid) {
                    // Determine which error message to show based on what's missing
                    if (!companyProvided && (!firstNameProvided || !lastNameProvided) ) {
                        // If company is missing, and either first or last name (or both) are missing
                        const generalErrorMsg = 'Either (First Name AND Last Name) OR Company mapping is required.';
                        errorMessagesArray.push(generalErrorMsg);

                        // Highlight all relevant fields that could satisfy the condition
                        if (!firstNameProvided) {
                            $firstNameField.addClass('is-invalid');
                            $firstNameField.closest('.form-group').find('.invalid-feedback').text('First Name or Company is required.').show();
                        }
                        if (!lastNameProvided) {
                            // Only show error for last name if first name was attempted or if it's part of the general guidance
                            $lastNameField.addClass('is-invalid');
                            $lastNameField.closest('.form-group').find('.invalid-feedback').text('Last Name or Company is required.').show();
                        }
                        if (!companyProvided) {
                            $companyField.addClass('is-invalid');
                            $companyField.closest('.form-group').find('.invalid-feedback').text('Company or (First AND Last Name) is required.').show();
                        }

                    } else if (firstNameProvided && !lastNameProvided && !companyProvided) {
                        // First name is there, but last name is missing, and company is also missing
                        const lastNameErrorMsg = 'Last Name is required if First Name is provided (or provide Company).';
                        errorMessagesArray.push(lastNameErrorMsg);
                        $lastNameField.addClass('is-invalid');
                        $lastNameField.closest('.form-group').find('.invalid-feedback').text(lastNameErrorMsg).show();
                        // Also remind about company as an alternative
                        $companyField.addClass('is-invalid');
                        $companyField.closest('.form-group').find('.invalid-feedback').text('Or provide Company.').show();


                    }
                    // No specific "else if" for (!firstNameProvided && lastNameProvided && !companyProvided)
                    // because the general message above should cover it by highlighting first name and company.
                }
                return isValid;
            }


            function validateConfigForm() {
                let isValid = true;
                const errorMessages = [];
                $('#configForm .is-invalid').removeClass('is-invalid');
                $('#configForm .invalid-feedback').hide().text(''); // Hide and clear text of all feedback divs in the form
                $('#error').hide();


                function validateSingleField(fieldId, errorMessage) {
                    const $field = $(`#${fieldId}`);
                    if (!$field.length || !$field.is(':visible')) { // Check if field exists and is visible
                         // If field doesn't exist or isn't visible, skip validation for it unless it's a critical base field
                        if ($field.prop('required') && !$field.is(':visible')) {
                            // This case might need special handling if a required field can be hidden
                            // For now, we assume visible required fields are the primary concern
                        }
                        return true;
                    }

                    let value = $field.val();
                    if (value === null || String(value).trim() === "") {
                        $field.addClass('is-invalid');
                        // Ensure the specific feedback div for this field is shown and has the message
                        let $feedback = $field.next('.invalid-feedback');
                        if (!$feedback.length) { // If no sibling, maybe it's in a parent or needs specific structure
                            $feedback = $field.closest('.form-group').find('.invalid-feedback');
                        }

                        if ($feedback.length) {
                           $feedback.text(errorMessage).show();
                        } else {
                             // Fallback if no specific div, though it's better to have one per field
                             console.warn("No invalid-feedback div found for " + fieldId);
                        }
                        errorMessages.push(errorMessage);
                        return false;
                    }
                    return true;
                }

                // Recipient Address
                if (!validateNameOrCompany('firstNameField', 'lastNameField', 'companyField', errorMessages)) {
                    isValid = false;
                    // The errorMessages array is populated by validateNameOrCompany
                    
                }
                //if (!validateSingleField('firstNameField', 'First Name mapping is required.')) isValid = false;
                //if (!validateSingleField('lastNameField', 'Last Name mapping is required.')) isValid = false;
                //if (!validateSingleField('companyField', 'Company mapping is required.')) isValid = false;
                if (!validateSingleField('streetField', 'Street mapping is required.')) isValid = false;
                if (!validateSingleField('cityField', 'City mapping is required.')) isValid = false;
                if (!validateSingleField('stateField', 'State mapping is required.')) isValid = false;
                if (!validateSingleField('postalCodeField', 'Postal/Zip Code mapping is required.')) isValid = false;
                if (!validateSingleField('designIdSelect', 'Design selection is required.')) isValid = false;
                if (!validateSingleField('mailClassSelect', 'MailClass selection is required.')) isValid = false;
                // Return Address
                // Recipient Address
                if (!validateNameOrCompany('rfirstNameField', 'rlastNameField', 'rcompanyField', errorMessages)) {
                    isValid = false;
                    // The errorMessages array is populated by validateNameOrCompany
                    
                }
                //if (!validateSingleField('rfirstNameField', 'First Name is required.')) isValid = false;
                //if (!validateSingleField('rlastNameField', 'Last Name is required.')) isValid = false;
                //if (!validateSingleField('rcompanyField', 'Company mapping is required.')) isValid = false;
                if (!validateSingleField('rstreetField', 'Street is required.')) isValid = false;
                if (!validateSingleField('rcityField', 'City is required.')) isValid = false;
                if (!validateSingleField('rstateField', 'State is required.')) isValid = false;
                if (!validateSingleField('rpostalCodeField', 'Postal Code is required.')) isValid = false;

                const selectedDesignId = $('#designIdSelect').val();
                if (selectedDesignId) {
                    const selectedDesignObject = designsData.find(d => d.designID === parseInt(selectedDesignId));
                    if (selectedDesignObject) {

                        if (selectedDesignObject.productType === 'letter') {
                            if ($('#envelopeOptionsContainer').is(':visible')) { // Only validate if visible
                                if (!validateSingleField('envelopeTypeField', 'Envelope Type is required.')) isValid = false;
                                if (!validateSingleField('envelopeFontField', 'Envelope Font is required.')) isValid = false;
                                if (!validateSingleField('envelopeFontColorField', 'Envelope Font Color is required.')) isValid = false;
                            }
                             // Note: letterColorField, letterPrintBothSidesField, letterInsertAddressPageField have defaults and don't have a "select" option
                        } else if (selectedDesignObject.productType === 'snapapart') {
                            if ($('#snapApartAddressingOptionsContainer').is(':visible')) { // Only validate if visible
                                if (!validateSingleField('snapApartFontField', 'Snap Apart Font is required.')) isValid = false;
                                if (!validateSingleField('snapApartFontColorField', 'Snap Apart Font Color is required.')) isValid = false;
                            }
                            // Note: snapApartColorField has defaults
                        }

                        // Dynamic Design Fields
                        if ($('#dynamicDesignFieldsContainer').is(':visible') && selectedDesignObject.designFields && selectedDesignObject.designFields.length > 0) {
                            selectedDesignObject.designFields.forEach(df => {
                                //if (df.mandatory) {
                                    const selectId = `dynamicField_${df.fieldKey}_select`;
                                    if (!validateSingleField(selectId, `${df.fieldLabel || df.fieldKey} mapping is required.`)) isValid = false;
                                //}
                            });
                        }
                    }
                }

                if (!isValid) {
                    $('#error').html('Please correct the highlighted errors:<br>' + errorMessages.join('<br>')).show();
                } else {
                    $('#error').hide();
                }
                return isValid;
            }


            connection.on('requestedSave', function() {
                console.log('requestedSave called');
                if (!validateConfigForm()) {
                    console.log('Form validation failed on save.');
                    // Postmonger doesn't have a specific "saveFailedValidation" trigger.
                    // SFMC will likely show a generic error or just not save.
                    // To inform SFMC about validation state for save, you might need to rely on validationFinished.
                    // However, requestedSave is usually about persisting the current state.
                    // We prevent updateActivity if invalid.
                    return;
                }
                updatePayload();
                console.log('Triggering updateActivity after save request');
                connection.trigger('updateActivity', payload);
            });

            connection.on('requestedValidate', function() {
                console.log('requestedValidate called');
                if (!validateConfigForm()) {
                    console.log('Validation failed for requestedValidate.');
                    connection.trigger('validationFinished', false); // Inform SFMC validation failed
                    return;
                }
                // If validation passes, update payload and then proceed
                updatePayload(); 
                console.log('Triggering updateActivity before validationFinished (true)');
                connection.trigger('updateActivity', payload); 
                console.log('Triggering validationFinished (true)');
                connection.trigger('validationFinished', true); // Inform SFMC validation passed
            });

            connection.on('clickedNext', function() {
                console.log('clickedNext called (Done button)');
                if (!validateConfigForm()) {
                    console.log('Validation failed on Next/Done.');
                    // Error message is already handled by validateConfigForm
                    // SFMC will prevent advancing if there's an error state often tied to validationFinished(false)
                    // or if the activity doesn't update its state correctly.
                    return; 
                }
                updatePayload();
                console.log('Triggering updateActivity before done');
                connection.trigger('updateActivity', payload);
                console.log('Triggering done');
                connection.trigger('done');
            });


            connection.on('updateActivity', function(data) {
                console.log('updateActivity triggered with data:', JSON.stringify(data));
            });

            connection.on('done', function() {
                console.log('done event triggered');
            });

            connection.on('validationFinished', function(success) {
                console.log('validationFinished triggered with success:', success);
            });

            connection.on('error', function(error) {
                console.error('Postmonger error:', error);
                $('#error').text('Postmonger error: ' + JSON.stringify(error)).show();
            });

            

            async function fetchDesigns(authToken) {
                $('#previewPanel').hide();
                console.log('Fetching designs from backend (/getDesigns)');
                    await fetch(`${window.APP_URL}/getDesigns`,{ 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            token: authToken 
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Designs data received from backend:', JSON.stringify(data));
                        designsData = data.results || []; // Store the designs data
                        const $designSelect = $('#designIdSelect');
                        // Clear previous options except the first one
                        $designSelect.find('option:not(:first)').remove();
                        designsData.forEach(design => {
                            $designSelect.append(`<option value="${design.designID}">${design.designID} - ${design.productType} - ${design.friendlyName}</option>`);
                        });
                        $('#error').hide();
                        // If there was a previously selected design ID from initActivity, re-apply it
                        if(fieldMappings.designId) {
                            $designSelect.val(fieldMappings.designId);
                            // Trigger change to re-render dynamic fields and product options based on loaded data
                            $designSelect.trigger('change'); 
                        }
                    })
                    .catch(error => {
                                console.error('Error fetching designs from backend:', error);
                        $('#error').text('Error: Failed to load designs. Please try again later.').show();
                    });
            }


            $('#designIdSelect').on('change', function() {
                const selectedDesignId = $(this).val();
                fieldMappings.designId = selectedDesignId; // Update fieldMappings
                
                if(selectedDesignId!=undefined && selectedDesignId!='')$('#previewPanel').show();
                else {
                    $('#previewPanel').hide();
                     $('#mailClassPanel').hide();
                }
                
                fieldMappings.dynamicFields = {}; // Reset dynamic mappings when design changes
                renderDynamicDesignFields(selectedDesignId);
                renderMailClassOptions(selectedDesignId);
                const selectedDesignObject = designsData.find(d => d.designID === parseInt(selectedDesignId));
                renderProductSpecificOptions(selectedDesignObject);
                 // After changing design, re-validate if you want immediate feedback or wait for next action
                // validateConfigForm(); 
            });

            function showDesignPreviewModal(designId) {
                const selectedDesign = designsData.find(design => design.designID === designId);
                const $pdfViewerContainerModal = $('#pdfViewerContainerModal');
                const $pdfViewerModal = $('#pdfViewerModal');
                const $imageCarouselModal = $('#imageCarouselModal');
        
                // Destroy existing carousel instance if it exists
                if ($imageCarouselModal.hasClass('owl-loaded')) {
                    $imageCarouselModal.trigger('destroy.owl.carousel').removeClass('owl-loaded');
                }
                $imageCarouselModal.empty().hide(); // Clear items and hide
                $pdfViewerContainerModal.hide();
                modal.style.display = "block"; // Show the modal
        
                if (selectedDesign) {
                    if (selectedDesign.productType === 'snapapart' || selectedDesign.productType === 'letter') {
                        if (selectedDesign.proofPDF) {
                            $pdfViewerModal.attr('src', selectedDesign.proofPDF);
                            $pdfViewerContainerModal.show();
                        }
                    } else if (selectedDesign.productType === 'postcard') {
                        if (selectedDesign.proofFront) {
                            $imageCarouselModal.append('<div class="item"><img src="' + selectedDesign.proofFront + '"></div>');
                        }
                        if (selectedDesign.proofBack) {
                             $imageCarouselModal.append('<div class="item"><img src="' + selectedDesign.proofBack + '"></div>');
                        }
                        if ($imageCarouselModal.children().length > 0) {
                            $imageCarouselModal.show();
                            if (typeof $imageCarouselModal.owlCarousel === 'function') {
                                $imageCarouselModal.owlCarousel({
                                    loop: $imageCarouselModal.children().length > 1, // Loop only if more than one item
                                    margin: 10,
                                    nav: true,
                                    items: 1,
                                    dots: $imageCarouselModal.children().length > 1
                                });
                            } else {
                                console.error('Owl Carousel function not found. Ensure the script is loaded correctly.');
                            }
                        }
                    }
                }
            }


            function populateFieldDropdowns() {
                console.log('Populating field dropdowns for schema:', JSON.stringify(schema));
                dataExtensionSchemaFields = schema
                    .filter(item => item.key.includes(`.${dataExtensionKey}.`)) // Ensure we are getting fields for the correct DE
                    .map(item => {
                        const fieldName = item.key.split('.').pop();
                        return { name: fieldName, key: fieldName }; // key should be the actual field name from DE
                    });

                console.log('Fields for DE "' + dataExtensionKey + '":', JSON.stringify(dataExtensionSchemaFields));

                const fieldSelects = [
                    'firstNameField', 'lastNameField','companyField', 'streetField',
                    'cityField', 'stateField', 'postalCodeField' // 'countryField' is commented out in HTML
                ];

                fieldSelects.forEach(selectId => {
                    const $select = $(`#${selectId}`);
                    $select.find('option:not(:first)').remove(); // Clear previous options except the placeholder
                    dataExtensionSchemaFields.forEach(field => {
                        $select.append(`<option value="${field.key}">${field.name}</option>`);
                    });
                });

                // Default selections (if previously saved, initActivity handles it)
                // This part for auto-selecting common names might be redundant if initActivity correctly populates fieldMappings
                // fieldMappings.firstName = fieldMappings.firstName || (dataExtensionSchemaFields.some(f => f.key.toLowerCase() === 'firstname' || f.key.toLowerCase() === 'first_name') ? dataExtensionSchemaFields.find(f => f.key.toLowerCase() === 'firstname' || f.key.toLowerCase() === 'first_name').key : '');
                // ... and so on for other fields. For simplicity, relying on initActivity's loaded values.

                updateFieldSelections(); // This will apply any loaded mappings
            }

            function renderProductSpecificOptions(selectedDesign) {
                const $letterOptionsContainer = $('#letterOptionsContainer');
                const $envelopeOptionsContainer = $('#envelopeOptionsContainer');
                const $snapApartOptionsContainer = $('#snapApartOptionsContainer'); 
                const $snapApartAddressingOptionsContainer = $('#snapApartAddressingOptionsContainer');

                $letterOptionsContainer.hide();
                $envelopeOptionsContainer.hide();
                $snapApartOptionsContainer.hide(); 
                $snapApartAddressingOptionsContainer.hide();

                if (!selectedDesign) {
                    return;
                }

                if (selectedDesign.productType === 'letter') {
                    populateSelectWithOptions('envelopeTypeField', ENVELOPE_TYPES, '-- Select Envelope Type --');
                    populateSelectWithOptions('envelopeFontField', ENVELOPE_FONTS, '-- Select Envelope Font --');
                    populateSelectWithOptions('envelopeFontColorField', FONT_COLORS, '-- Select Font Color --');

                    $('#letterColorField').val(fieldMappings.letterColor || 'false');
                    $('#letterPrintBothSidesField').val(fieldMappings.letterPrintBothSides || 'false');
                    $('#letterInsertAddressPageField').val(fieldMappings.letterInsertAddressPage || 'false');
                    $('#envelopeTypeField').val(fieldMappings.envelopeType); // Apply saved value
                    $('#envelopeFontField').val(fieldMappings.envelopeFont);
                    $('#envelopeFontColorField').val(fieldMappings.envelopeFontColor);

                    $letterOptionsContainer.show();
                    $envelopeOptionsContainer.show();

                } else if (selectedDesign.productType === 'snapapart') {
                    populateSelectWithOptions('snapApartFontField', ENVELOPE_FONTS, '-- Select Snap Apart Font --'); 
                    populateSelectWithOptions('snapApartFontColorField', FONT_COLORS, '-- Select Font Color --'); 

                    $('#snapApartColorField').val(fieldMappings.snapApartColor || 'false');
                    $('#snapApartFontField').val(fieldMappings.snapApartFont); // Apply saved value
                    $('#snapApartFontColorField').val(fieldMappings.snapApartFontColor);

                    $snapApartOptionsContainer.show();
                    $snapApartAddressingOptionsContainer.show();
                }
            }

            function populateSelectWithOptions(selectId, optionsArray, defaultOptionText = "-- Select --") {
                const $select = $(`#${selectId}`);
                const currentValue = $select.val(); // Preserve current value if it's valid
                $select.empty(); 
                if (defaultOptionText) {
                    $select.append(`<option value="">${defaultOptionText}</option>`);
                }
                optionsArray.forEach(option => {
                    $select.append(`<option value="${option.key}">${option.label}</option>`);
                });
                // Try to reapply current value if it exists in new options
                if (optionsArray.some(opt => opt.key === currentValue)) {
                    $select.val(currentValue);
                }
            }

            function renderMailClassOptions(designId){
                const $container = $('#mailClassPanel');
                $container.hide();
                if (!designId || designId === '') {
                    fieldMappings.mailClass = '';
                    return;
                }
                const selectedDesign = designsData.find(d => d.designID === parseInt(designId));

                if (!selectedDesign || !selectedDesign.mailClasses || selectedDesign.mailClasses.length === 0) {
                    return; 
                }

                const $mailClassSelect = $('#mailClassSelect');
                $mailClassSelect.empty(); 

                $container.show(); 
                //have to clear options on every load
                
                $mailClassSelect.append('<option value="">-- Select MailClass --</option>');
                let currentMailClassStillValid = false;
                selectedDesign.mailClasses.forEach(mailClass => {
                    const mailClassValue = String(mailClass).trim(); // Ensure it's a string and trim
                    $mailClassSelect.append(`<option value="${mailClassValue}">${mailClassValue}</option>`);
                    if (mailClassValue === fieldMappings.mailClass) {
                        currentMailClassStillValid = true;
                    }
                });

                if (currentMailClassStillValid) {
                    $mailClassSelect.val(fieldMappings.mailClass);
                } else {
                    fieldMappings.mailClass = ''; 
                    $mailClassSelect.val(''); 
                }

            }

            function renderDynamicDesignFields(designId) {
                const $container = $('#dynamicDesignFieldsContainer');
                $container.empty(); 
                $('#dynamicDesignFieldsContainerTitle').remove();
                // fieldMappings.dynamicFields is reset when designId changes in the event handler.

                if (!designId || designId === '') {
                    return;
                }

                const selectedDesign = designsData.find(d => d.designID === parseInt(designId));

                if (!selectedDesign || !selectedDesign.designFields || selectedDesign.designFields.length === 0) {
                    return; 
                }

                $container.before('<h5 id="dynamicDesignFieldsContainerTitle" class=" mb-2">Variable mapping</h5>');

                selectedDesign.designFields.forEach(df => {
                    const fieldKey = df.fieldKey;
                    const fieldLabel = df.fieldLabel || fieldKey; 
                    const isMandatory = df.mandatory || false;
                    const selectId = `dynamicField_${fieldKey}_select`;

                    const $fieldGroup = $('<div class="form-group col-md-12 mb-3"></div>'); 
                    const $label = $(`<label for="${selectId}">${fieldLabel}${isMandatory ? ' <span style="color:red;">*</span>' : ''}:</label>`);
                    // Add 'required' attribute if mandatory for basic HTML5 validation
                    const $select = $(`<select class="form-control" id="${selectId}" name="dynamicField_${fieldKey}" ${isMandatory ? 'required' : ''}></select>`);

                    $select.append('<option value="">-- Select Mapping --</option>');
                    if (dataExtensionSchemaFields && dataExtensionSchemaFields.length > 0) {
                        dataExtensionSchemaFields.forEach(deField => {
                            $select.append(`<option value="${deField.key}">${deField.name}</option>`);
                        });
                    } else {
                        $select.append('<option value="" disabled>No Data Extension fields available</option>');
                        console.warn("dataExtensionSchemaFields is empty or not yet populated when rendering dynamic fields.");
                    }
                    
                    // Apply saved value for this dynamic field if it exists
                    if (fieldMappings.dynamicFields && fieldMappings.dynamicFields[fieldKey]) {
                        $select.val(fieldMappings.dynamicFields[fieldKey]);
                    }

                    $select.on('change', function() {
                        fieldMappings.dynamicFields[fieldKey] = $(this).val();
                        console.log(`Updated dynamic field mapping - ${fieldKey}: ${$(this).val()}`);
                        // validateConfigForm(); // Optional: validate on change
                    });

                    $fieldGroup.append($label).append($select);
                    if (isMandatory) { // Add feedback div for Bootstrap styling
                        $fieldGroup.append('<div class="invalid-feedback">This mapping is required.</div>');
                    }
                    $container.append($fieldGroup);
                });
            }

            function updateFieldSelections() {
                $('#firstNameField').val(fieldMappings.firstName);
                $('#lastNameField').val(fieldMappings.lastName);
                $('#companyField').val(fieldMappings.company);
                $('#streetField').val(fieldMappings.street);
                $('#cityField').val(fieldMappings.city);
                $('#stateField').val(fieldMappings.state);
                $('#postalCodeField').val(fieldMappings.postalCode);
                // $('#countryField').val(fieldMappings.country); // If used

                $('#rfirstNameField').val(fieldMappings.rfirstName);
                $('#rlastNameField').val(fieldMappings.rlastName);
                $('#rcompanyField').val(fieldMappings.rcompany);
                $('#rstreetField').val(fieldMappings.rstreet);
                $('#rcityField').val(fieldMappings.rcity);
                $('#rstateField').val(fieldMappings.rstate);
                $('#rpostalCodeField').val(fieldMappings.rpostalCode);

                $('#designIdSelect').val(fieldMappings.designId);
                if (fieldMappings.designId && fieldMappings.designId !== '') {
                    $('#previewPanel').show();
                    renderDynamicDesignFields(fieldMappings.designId); // This will also apply saved dynamic field values
                    renderMailClassOptions(fieldMappings.designId); // Populates mail classes
                    const selectedDesignObject = designsData.find(d => d.designID === parseInt(fieldMappings.designId));
                    renderProductSpecificOptions(selectedDesignObject); // This will show/hide and set values
                } else {
                    $('#previewPanel').hide();
                    renderDynamicDesignFields(null); 
                    $('#dynamicDesignFieldsContainerTitle').remove();
                    renderMailClassOptions(null); // Clear/hide mail class options
                    $('#mailClassSelect').val('');
                    // Also hide product specific options if no design is selected
                    $('#letterOptionsContainer, #envelopeOptionsContainer, #snapApartOptionsContainer, #snapApartAddressingOptionsContainer').hide();
                }
                console.log('Updated field selections based on fieldMappings:', fieldMappings);
            }
            
            // Centralized change handler for mapped fields and return address inputs
            $('#configForm').on('change input', 'select, input[type="text"]', function() {
                const fieldName = $(this).attr('id'); // e.g., 'firstNameField', 'rfirstNameField'
                const value = $(this).val();

                if (fieldName.startsWith('r')) { // Return address fields
                     fieldMappings[fieldName.replace('Field', '')] = value; // e.g., rfirstName
                } else if(fieldName.endsWith('Field')) { // Mapped DE fields (selects)
                     fieldMappings[fieldName.replace('Field', '')] = value; // e.g., firstName
                } else if (fieldName === 'designIdSelect') {
                    // This is handled by its own specific 'change' handler already
                } else if (fieldName === 'mailClassSelect') {
                    fieldMappings.mailClass = value;
                } else if (this.name && this.name.startsWith('dynamicField_')) {
                     // This is handled by its own specific 'change' handler in renderDynamicDesignFields
                } else if (this.name && (this.name.startsWith('letter') || this.name.startsWith('envelope') || this.name.startsWith('snapApart'))) {
                    // Product specific options
                    const mappingKey = this.name.replace('Field', ''); // e.g. letterColor, envelopeType
                    fieldMappings[mappingKey] = value;
                }


                // If it's a select for DE mapping, store the selected DE field name
                // For example, if #firstNameField (a select) changes, fieldMappings.firstName gets the DE column name
                // if (this.id === 'firstNameField') fieldMappings.firstName = value;
                // ... (this is now more generically handled by the replace logic above)

                console.log(`Field mapping updated - ${this.id}: ${value}`);
                 // Optional: validate on any change for immediate feedback.
                // Be mindful of performance or user experience if validation is too frequent.
                // validateConfigForm(); 
            });


            $('#saveButton').click(function() { // This button is currently commented out in HTML
                console.log('Save button clicked');
                if (!validateConfigForm()) {
                    console.log('Validation failed on Save button click.');
                    return;
                }
                updatePayload();
                console.log('Triggering updateActivity after save');
                connection.trigger('updateActivity', payload);
                // $('#error').hide(); // Already handled by validateConfigForm
            });

            function updatePayload() {
                console.log('Updating payload with field mappings:', fieldMappings);
                const inArgumentsPayload = {
                    "dataExtension": dataExtensionKey,
                    // Static DE mappings (store the DE field name in _field, and the GTL in the direct key)
                    "first_name_field": fieldMappings.firstName,
                    "first_name": fieldMappings.firstName ? `{{Event.${dataExtensionKey}.${fieldMappings.firstName}}}` : '',
                    "last_name_field": fieldMappings.lastName,
                    "last_name": fieldMappings.lastName ? `{{Event.${dataExtensionKey}.${fieldMappings.lastName}}}` : '',
                    "company_field": fieldMappings.company,
                    "company": fieldMappings.company ? `{{Event.${dataExtensionKey}.${fieldMappings.company}}}` : '',
                    "street_field": fieldMappings.street,
                    "street": fieldMappings.street ? `{{Event.${dataExtensionKey}.${fieldMappings.street}}}` : '',
                    "city_field": fieldMappings.city,
                    "city": fieldMappings.city ? `{{Event.${dataExtensionKey}.${fieldMappings.city}}}` : '',
                    "state_field": fieldMappings.state,
                    "state": fieldMappings.state ? `{{Event.${dataExtensionKey}.${fieldMappings.state}}}` : '',
                    "postal_code_field": fieldMappings.postalCode,
                    "postal_code": fieldMappings.postalCode ? `{{Event.${dataExtensionKey}.${fieldMappings.postalCode}}}` : '',
                    // "country_field": fieldMappings.country, // If used
                    // "country": fieldMappings.country ? `{{Event.${dataExtensionKey}.${fieldMappings.country}}}` : '',
                    
                    "selectedDesignId" : fieldMappings.designId, 
                    "mailClass": fieldMappings.mailClass,
                    "mid" : sfmcMID,

                    // Return address fields from fieldMappings (which are updated by the 'change' event)
                    "rfirst_name": fieldMappings.rfirstName, 
                    "rlast_name": fieldMappings.rlastName,
                    "rcompany": fieldMappings.rcompany,
                    "rstreet": fieldMappings.rstreet,
                    "rcity": fieldMappings.rcity,
                    "rstate": fieldMappings.rstate,
                    "rpostal_code": fieldMappings.rpostalCode
                };

                const dynamicFieldsToSave = {};
                if (fieldMappings.dynamicFields) {
                    for (const fieldKey in fieldMappings.dynamicFields) {
                        if (fieldMappings.dynamicFields.hasOwnProperty(fieldKey) && fieldMappings.dynamicFields[fieldKey]) {
                            const deColumnName = fieldMappings.dynamicFields[fieldKey];
                            // Key for storing which DE column is mapped
                            dynamicFieldsToSave[`df_${fieldKey}_mappedTo`] = deColumnName; 
                            // Key for the actual Journey Builder personalization string (not strictly needed in inArguments if backend reconstructs)
                            // dynamicFieldsToSave[`df_${fieldKey}_value`] = `{{Event.${dataExtensionKey}.${deColumnName}}}`;
                        }
                    }
                }
                if (Object.keys(dynamicFieldsToSave).length > 0) {
                    inArgumentsPayload.dynamic_fields = JSON.stringify(dynamicFieldsToSave);
                }


                const selectedDesignObject = designsData.find(d => d.designID === parseInt(fieldMappings.designId));
                if (selectedDesignObject) {
                    inArgumentsPayload.product_type = selectedDesignObject.productType;
                    
                    if (selectedDesignObject.productType === 'letter') {
                        const letterOptionsObject = {
                            letterColor: fieldMappings.letterColor === 'true',
                            letterPrintBothSides: fieldMappings.letterPrintBothSides === 'true',
                            letterInsertAddressPage: fieldMappings.letterInsertAddressPage === 'true',
                            envelopeType: fieldMappings.envelopeType,
                            envelopeFont: fieldMappings.envelopeFont,
                            envelopeFontColor: fieldMappings.envelopeFontColor
                        };
                        inArgumentsPayload.letter_options = JSON.stringify(letterOptionsObject);
                    } else if (selectedDesignObject.productType === 'snapapart') {
                         const snapapartOptionsObject = {
                            snapApartColor: fieldMappings.snapApartColor === 'true',
                            snapApartFont: fieldMappings.snapApartFont,
                            snapApartFontColor: fieldMappings.snapApartFontColor
                        };
                        inArgumentsPayload.snapapart_options = JSON.stringify(snapapartOptionsObject);
                    }
                }

                payload['arguments'] = payload['arguments'] || {};
                payload['arguments'].execute = payload['arguments'].execute || {};
                payload['arguments'].execute.inArguments = [inArgumentsPayload];


                payload['configurationArguments'] = payload['configurationArguments'] || {};
                payload['configurationArguments'].save = { 
                    url: `${window.APP_URL}/save`, 
                    verb: "POST", 
                    useJwt: true, 
                    body: JSON.stringify(inArgumentsPayload) // Send the inArguments directly if your save endpoint expects them
                };
                payload['configurationArguments'].validate = { 
                    url: `${window.APP_URL}/validate`, 
                    verb: "POST", 
                    useJwt: true, 
                };
                payload['configurationArguments'].publish = { 
                    url: `${window.APP_URL}/publish`, 
                    verb: "POST", 
                    useJwt: true, 
                };
                payload['metaData'] = payload['metaData'] || {};
                payload.metaData.midForVerification = sfmcMID;
                payload['metaData'].isConfigured = true; 
                payload['errors'] = null;
                console.log('Updated payload for SFMC:', JSON.stringify(payload));
            }
        }
    </script>
</body>
</html>